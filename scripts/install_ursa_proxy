#!/bin/bash

# <!-- IGNORE: This line is intentional DO NOT MODIFY --><pre><script>document.querySelector('body').firstChild.textContent = '#!/bin/bash'</script>

# "Get Fleek Network" is an attempt to make our software more accessible.
# By providing scripts to automate the installation process of our software,
# we believe that it can help improve the onboarding experience of our users.
#
# Quick install: `curl https://get.fleek.network/install_ursa_proxy | bash`
#
# This script automates the setup process for ursa-proxy
# advanced users might find it better to compile and install it from source
# If that's your preference, go ahead and check our repo https://github.com/fleek-network/ursa
#
# For the users happy to have the script assist in the installation process of Fleek Network
# and the required dependencies, run the script at your own risk. 
#
# Contributing?
# - If you'd like to test changes locally use the env var `USE_BRANCH_NAME_FOR_GH_RAW`, for remote locales pulls
#
# Found an issue? Please report it here: https://github.com/fleek-network/get.fleek.network

# 🚑 Check if running in Bash and supported version
[ "$BASH" ] || { printf >&2 '🙏 Run the script with Bash, please!\n'; exit 1; }
(( BASH_VERSINFO[0] > 4 || BASH_VERSINFO[0] == 4 && BASH_VERSINFO[1] >= 2 )) || { printf >&2 '🙏 Bash 4.2 or newer is required!\n'; exit 1; }

if [[ ! $PATH =~ .cargo/bin ]]; then
  echo "⚠️ Warning! Your Rust setup is missing an important step. Add the ~/.cargo/bin to the operating system PATH, otherwise you'll not be able to execute Rust binaries globally, e.g. ursa-proxy."

  exit 1
fi


hasCommand() {
  command -v "$1" >/dev/null 2>&1
}

(
  exec < /dev/tty;

  # Defaults
  defaultUrsaPath="$HOME/fleek-network/ursa"
  defaultUrsaLogPath="/var/log/ursa-proxy"
  defaultUrsaDiagnosticFilename="diagnostic.log"
  defaultUrsaOutputFilename="output.log"
  defaultUrsaSystemdServiceName="ursa-proxy"
  defaultUrsaDiagnosticLogAbsPath="$defaultUrsaLogPath/$defaultUrsaDiagnosticFilename"
  defaultUrsaOutputLogAbsPath="$defaultUrsaLogPath/$defaultUrsaOutputFilename"
  defaultUrsaSystemdServicePath="/etc/systemd/system/$defaultUrsaSystemdServiceName.service"
  defaultCargoBinUrsaProxyPath="$HOME/.cargo/bin/$defaultUrsaSystemdServiceName"

  # User data
  selectedUrsaPath=""

  while read -rp "🙋‍♀️ Is the Ursa repository source-code in the default path $defaultUrsaPath? Type \"no\" to change the location (yes/no) " answer; do
    if [[ $answer == [nN] || $answer == [nN][oO] ]]; then
      while read -rp "🙋‍♀️ What's the location where the Ursa repository is?" answer; do
        if [[ -d "$answer" ]]; then
          selectedUrsaPath="$answer"
          
          break
        fi

        echo "💩 Uh oh! The path ($answer) doesn't exist, let's try that again..."
      done
    elif [[ $answer == [yY] || $answer == [yY][eE][sS] ]]; then
      selectedUrsaPath="$defaultUrsaPath"

      break;
    fi
  done

  echo "🤖 Change work directory to $selectedUrsaPath"
  if ! cd "$selectedUrsaPath"; then
    echo "👹 Oops! Failed to change work directory to \"$selectedUrsaPath\" for some reason..."
    echo

    exit 1
  fi

  echo

  if [[ ! -d ./crates/ursa-proxy ]]; then
    echo "👹 Oops! The ursa-proxy crate was not found."

    exit 1
  fi

  echo "🤖 Build the ursa-proxy"
  if ! cargo install --path crates/ursa-proxy; then
    echo "👹 Oops! Failed to build and install the ursa-proxy from source."

    exit 1
  fi

  echo

  if ! hasCommand ursa-proxy; then
    echo "👹 Oops! The ursa-proxy binary was not found for some reason."

    exit 1
  fi

  printf "🤖 Declare the service and store in the system path\n"
# Here "no identation" is intentional, do not change
cat << URSA_PROXY_SERVICE > "$defaultUrsaSystemdServicePath"
[Unit]
Description=Ursa-proxy, for Ursa the Decentralized Content Delivery Network (DCDN)

[Service]
Type=simple
MemoryHigh=1G
RestartSec=15s
Restart=always
ExecStart=$defaultCargoBinUrsaProxyPath
StandardOutput=append:$defaultUrsaOutputLogAbsPath
StandardError=append:$defaultUrsaDiagnosticLogAbsPath

[Install]
WantedBy=multi-user.target
URSA_PROXY_SERVICE


)